<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Hacker News</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel&family=Source+Code+Pro:wght@500&family=Source+Sans+Pro:ital,wght@0,400;0,600;1,400&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        font-size: 20px;
        --hnr-baseline-grid: 26px;
        --hnr-gap: 2px;
      }
      body {
        font: 1rem / var(--hnr-baseline-grid) "Source Sans Pro", sans-serif;
        margin: 2rem;
      }
      a {
        text-decoration: none;
        color: #f60;
        transition: 0.2s;
      }
      p {
        margin: var(--hnr-baseline-grid) 0;
      }
      a:hover {
        text-decoration: underline;
      }
      h1 {
        text-align: center;
        font: 4rem/1 "Cinzel", serif;
        font-weight: 400;
        margin: calc(var(--hnr-baseline-grid) * 4) 0 calc(var(--hnr-baseline-grid) * 3);
      }
      #stories-picker {
        margin-top: 0;
      }
      #stories-picker a {
        cursor: pointer;
      }
      #stories-picker .highlight {
        font-weight: bold;
      }
      main {
        max-width: 64rem;
        margin: auto;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        column-gap: 2rem;
      }
      .contents {
        grid-column: span 2;
      }
      #news-list {
        padding: 0;
      }
      #news-list li {
        list-style: none;
        margin: 0 -0.25rem calc(var(--hnr-baseline-grid) / 2 - var(--hnr-gap));
        padding: 0 0.25rem var(--hnr-gap);
        cursor: pointer;
      }
      #news-list .highlight {
        background: #f60;
        color: white;
      }
      #links {
        margin-top: 0;
        font-weight: bold;
      }
      details p {
        margin: calc(var(--hnr-baseline-grid) / 2) 0;
      }
      details + details {
        margin-top: var(--hnr-baseline-grid);
        box-sizing: border-box;
        border-top: 1px solid #dfdfdf;
        padding-top: calc(var(--hnr-baseline-grid) - 1px);
      }
      details details {
        margin-top: var(--hnr-baseline-grid);
        margin-left: 2rem;
      }
      details.loading::after {
        content: "…";
        margin-left: 2rem;
      }
      summary {
        outline: none;
      }
      summary::marker {
        color: #f60;
      }
      summary::-webkit-details-marker {
        color: #f60;
      }
      pre {
        font-size: calc(var(--hnr-baseline-grid) * 2 / 3);
        line-height: 1;
      }
      code {
        font-family: "Source Code Pro", monospace;
        font-weight: 500;
      }
      .empty summary {
        list-style: none;
      }
      .empty summary::-webkit-details-marker {
        display: none;
      }
      .op {
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>Hacker News</h1>
    <main>
      <div id="news">
        <p id="stories-picker">
          <a id="topstories">Top</a> | <a id="newstories">New</a> | <a id="beststories">Best</a>
        </p>
        <ul id="news-list">
          loading…
        </ul>
        <footer>
          <a href="https://news.ycombinator.com/news">Hacker News</a> |
          <a href="https://github.com/hackernews/api">API</a> | <a href="https://github.com/chadluo/hnr">Repo</a>
        </footer>
      </div>
      <div class="contents">
        <p id="links">Hacker News</p>
        <div id="comments">comments</div>
      </div>
    </main>
    <script>
      "use strict";
      const HACKER_NEWS_API = "https://hacker-news.firebaseio.com/v0";
      const HACKER_NEWS_ITEM = `https://news.ycombinator.com/item?id=`;
      const HIGHLIGHT = "highlight";
      const LOADING = "loading";
      const CLUSTER_SIZE = 10;

      let params = new URLSearchParams(window.location.search);
      const COUNT = params.get("count") || 20;

      refreshNewsList(true);
      setInterval(refreshNewsList, 60_000);

      async function refreshNewsList(alsoLoadComments) {
        let storyType = sessionStorage.getItem("storyType") || "topstories";
        let link = document.getElementById(storyType);
        highlight(link);
        let storyIds = await fetch(`${HACKER_NEWS_API}/${storyType}.json?limitToFirst=${COUNT}&orderBy="$priority"`)
          .then(status)
          .then(json);
        let prevHighlight = parseInt(sessionStorage.getItem(HIGHLIGHT));
        if (prevHighlight && !storyIds.includes(prevHighlight)) storyIds.push(prevHighlight);
        let items = await Promise.all(storyIds.map(getItem));
        let news = document.getElementById("news-list");
        news.innerText = "";
        items.forEach((item) => {
          let li = news.appendChild(document.createElement("li"));
          li.innerText = item.title;
          li.dataset.id = item.id;
          if (item.id === prevHighlight) {
            li.classList.add(HIGHLIGHT);
            if (alsoLoadComments) renderNewsItem(li);
          }
        });
      }

      document.getElementById("stories-picker").addEventListener("click", (event) => {
        if (event.target.tagName !== "A") return;
        let link = event.target;
        highlight(link);
        sessionStorage.setItem("storyType", link.id);
        refreshNewsList(false);
      });

      document.getElementById("news-list").addEventListener("click", (event) => {
        if (event.target.tagName !== "LI") return;
        let li = event.target;
        highlight(li);
        renderNewsItem(li);
      });

      async function renderNewsItem(li) {
        let comments = document.getElementById("comments");
        comments.innerText = "loading…";
        let itemId = li.dataset.id;
        sessionStorage.setItem(HIGHLIGHT, itemId);
        let item = await requestItem(itemId);
        li.innerText = item.title;
        renderLinks(item);
        if (!("kids" in item)) {
          comments.innerText = "";
          return;
        }
        comments.innerText = "";
        renderCluster(item.kids, item.by, 0);
        async function renderCluster(kids, by, index) {
          if (index >= kids.length) return;
          let currentCluster = kids.slice(index, Math.min(index + CLUSTER_SIZE, kids.length));
          let cs = await Promise.all(currentCluster.map((id) => requestComment(id, by, true)));
          cs.filter(notNull).forEach((c) => comments.appendChild(c));
          renderCluster(kids, by, index + CLUSTER_SIZE);
        }
      }

      function renderLinks(item) {
        document.getElementById("links").innerHTML = `<a href="${item.url || HACKER_NEWS_ITEM + item.id}">${
          item.title
        }</a> | <a href="${HACKER_NEWS_ITEM + item.id}"> ${
          item.descendants && item.descendants > 0 ? item.descendants + "&nbsp;comments" : "No comments yet"
        }`;
      }

      async function renderChildComments(comment, op, kids) {
        if (!Array.isArray(kids)) return;
        comment.classList.add(LOADING);
        let cs = await Promise.all(kids.map((id) => requestComment(id, op)));
        comment.classList.remove(LOADING);
        cs.filter(notNull).forEach((c) => {
          comment.appendChild(c);
          renderChildComments(c, op, c.kids);
        });
      }

      async function requestComment(id, op, lazyLoad) {
        let item = await requestItem(id);
        if (item === null || item.deleted || item.dead) return null;
        let comment = document.createElement("details");
        let commentText = comment.appendChild(document.createElement("summary"));
        commentText.innerHTML = `${item.text} [<a ${op === item.by ? "class='op'" : ""} href="${
          HACKER_NEWS_ITEM + id
        }">${item.by}</a>]`;
        if (!("kids" in item)) {
          comment.classList.add("empty");
        } else if (lazyLoad) {
          comment.addEventListener("toggle", () => renderChildComments(comment, op, item.kids), { once: true });
        } else {
          renderChildComments(comment, op, item.kids);
        }
        return comment;
      }

      function highlight(node) {
        node.parentNode.childNodes.forEach((n) => {
          if (n.tagName === node.tagName) n.classList.remove(HIGHLIGHT);
        });
        node.classList.add(HIGHLIGHT);
      }

      function notNull(x) {
        return x !== null;
      }

      async function getItem(id) {
        let cached = sessionStorage.getItem(id);
        if (cached !== null) {
          return JSON.parse(cached);
        } else {
          let requested = await requestItem(id);
          cacheItem(requested);
          return requested;
        }
      }

      function requestItem(id) {
        return fetch(`${HACKER_NEWS_API}/item/${id}.json`).then(status).then(json);
      }

      function cacheItem(item) {
        if (item && item.id) {
          item.hnr_refresh = Date.now();
          sessionStorage.setItem(item.id, JSON.stringify(item));
        }
      }

      function status(response) {
        if (response.status >= 200 && response.status < 300) {
          return Promise.resolve(response);
        } else {
          return Promise.reject(new Error(response.statusText));
        }
      }

      function json(response) {
        return response.json();
      }
    </script>
  </body>
</html>
