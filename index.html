<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hacker News</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel&family=Open+Sans:ital@0;1&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        font-size: 16px;
      }
      body {
        font: 1rem/1.25 "Open Sans", sans-serif;
      }
      a {
        text-decoration: none;
        color: black;
        transition: 0.2s;
      }
      a:visited {
        color: #666;
      }
      a:hover {
        color: #f60;
      }
      h1 {
        text-align: center;
        font-family: "Cinzel", serif;
        font-size: 4rem;
        font-weight: 400;
      }
      main {
        width: calc(100% - 2rem);
        max-width: 60rem;
        margin: auto;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        column-gap: 2rem;
      }
      .contents {
        grid-column: span 2;
      }
      ul {
        margin: 0;
        padding: 0;
      }
      li {
        list-style: none;
        margin: -2px -0.25em 0.5em;
        padding: 2px 0.25em;
      }
      .highlight {
        background: #f60;
        color: white;
      }

      details {
        margin-bottom: 0.5em;
      }
      details[open] {
        background: #ffffe0;
      }
      summary {
        outline: none;
      }
      details details {
        margin-left: 2rem;
      }
    </style>
  </head>
  <body>
    <h1>Hacker News</h1>
    <main>
      <ul id="news">
        loading...
      </ul>
      <div class="contents">
        <div id="comments">comments</div>
        <p id="more"></p>
      </div>
    </main>
    <script>
      "use strict";
      const HACKER_NEWS_API = "https://hacker-news.firebaseio.com/v0";
      const HACKER_NEWS_ITEM = `https://news.ycombinator.com/item?id=`;

      let params = new URLSearchParams(window.location.search);
      const COUNT = params.get("count") || 20;

      refreshHackerNews();
      setInterval(refreshHackerNews, 60_000);

      function refreshHackerNews() {
        fetch(`${HACKER_NEWS_API}/topstories.json?limitToFirst=${COUNT}&orderBy="$priority"`)
          .then(status)
          .then(json)
          .then((topStoryIds) => Promise.all(topStoryIds.map(getItem)))
          .then(renderItems);
      }

      function renderItems(items) {
        let news = document.getElementById("news");
        news.innerText = "";
        let prevHighlight = parseInt(sessionStorage.getItem("highlight"));
        items.forEach((item) => {
          let url = item.url || HACKER_NEWS_ITEM + item.id;
          let li = document.createElement("li");
          li.innerText = item.title;
          if (item.id === prevHighlight) {
            li.classList.add("highlight");
          }
          li.addEventListener("click", async (event) => {
            news.childNodes.forEach((item) => item.classList.remove("highlight"));
            li.classList.add("highlight");
            renderComments(item.id, 10, 5);

            let more = document.getElementById("more");
            more.innerHTML = `<p>${item.url ? `<a href="${item.url}">Source</a> | ` : ""}<a href="${
              HACKER_NEWS_ITEM + item.id
            }">More comments</a>`;

            sessionStorage.setItem("highlight", item.id);
          });
          li.addEventListener("auxclick", (event) => {
            // middle
            if (event.which === 2) {
              event.preventDefault();
              window.open(url).focus();
            }
          });

          news.appendChild(li);
        });
      }

      async function renderComments(rootId, width, depth) {
        let comments = document.getElementById("comments");
        comments.innerText = "";

        let item = await requestItem(rootId);
        if (item.hasOwnProperty("kids")) {
          item.kids
            .splice(0, Math.min(item.kids.length, width))
            .forEach((kidId) => renderComment(comments, kidId, width, depth - 1));
        } else {
          comments.appendChild(document.createTextNode("No comments yet"));
        }
      }

      async function renderComment(parent, id, width, depth) {
        let item = await requestItem(id);

        if (item.deleted) {
          return;
        }

        let currentComment = document.createElement("details");
        let commentText = document.createElement("summary");
        commentText.innerHTML = `${item.text} [<a href="${HACKER_NEWS_ITEM + item.id}">${item.by}</a>]`;
        currentComment.prepend(commentText);
        parent.appendChild(currentComment);

        if (depth >= 0 && item.hasOwnProperty("kids")) {
          item.kids
            .slice(0, Math.min(item.kids.length, width))
            .forEach((kidId) => renderComment(currentComment, kidId, width, depth - 1));
        }
      }

      async function getItem(id) {
        let cached = sessionStorage.getItem(id);
        if (cached !== null) {
          return JSON.parse(cached);
        } else {
          let requested = await requestItem(id);
          sessionStorage.setItem(id, JSON.stringify(requested));
          return requested;
        }
      }

      function requestItem(id) {
        return fetch(`${HACKER_NEWS_API}/item/${id}.json`).then(status).then(json);
      }

      function status(response) {
        if (response.status >= 200 && response.status < 300) {
          return Promise.resolve(response);
        } else {
          return Promise.reject(new Error(response.statusText));
        }
      }

      function json(response) {
        return response.json();
      }
    </script>
  </body>
</html>
