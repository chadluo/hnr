<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Hacker News</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel&family=Source+Sans+Pro:ital,wght@0,400;0,700;1,400&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Source Sans Pro", sans-serif;
      }
      a {
        text-decoration: none;
        color: #f60;
        transition: 0.2s;
      }
      a:visited {
        color: #666;
      }
      a:hover {
        text-decoration: underline;
      }
      h1 {
        text-align: center;
        font: 4rem/1 "Cinzel", serif;
        font-weight: 400;
        margin: 4rem 0;
      }
      main {
        width: calc(100% - 2rem);
        max-width: 60rem;
        margin: auto;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        column-gap: 2rem;
      }
      .contents {
        grid-column: span 2;
      }
      ul {
        margin: 2px 0 0;
        padding: 0;
      }
      li {
        list-style: none;
        margin: -2px -0.25em 0.5em;
        padding: 2px 0.25em;
        cursor: pointer;
      }
      .highlight {
        background: #f60;
        color: white;
      }
      #links {
        margin-top: 0;
        font-weight: bold;
      }
      details {
        margin-bottom: 1rem;
        padding-right: 1rem;
        border-right: 2px solid white;
      }
      details[open] {
        border-color: #f60;
      }
      summary {
        outline: none;
      }
      details details {
        margin-left: 2rem;
      }
      details .more {
        text-indent: 2rem;
      }
      .op {
        font-weight: bold;
      }
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <h1>Hacker News</h1>
    <main>
      <ul id="news">
        loading…
      </ul>
      <div class="contents">
        <p id="links">Hacker News</p>
        <div id="comments">comments</div>
      </div>
    </main>
    <script>
      "use strict";
      const HACKER_NEWS_API = "https://hacker-news.firebaseio.com/v0";
      const HACKER_NEWS_ITEM = `https://news.ycombinator.com/item?id=`;
      const COMMENT_TREE_WIDTH = 10;
      const COMMENT_TREE_DEPTH = 3;
      const ELLIPSIS = "…";
      const HIGHLIGHT = "highlight";

      let params = new URLSearchParams(window.location.search);
      const COUNT = params.get("count") || 20;

      refreshHackerNews();
      setInterval(refreshHackerNews, 60_000);

      function refreshHackerNews() {
        fetch(`${HACKER_NEWS_API}/topstories.json?limitToFirst=${COUNT}&orderBy="$priority"`)
          .then(status)
          .then(json)
          .then((topStoryIds) => {
            let prevHighlight = parseInt(sessionStorage.getItem(HIGHLIGHT));
            if (prevHighlight && !topStoryIds.includes(prevHighlight)) topStoryIds.push(prevHighlight);
            return Promise.all(topStoryIds.map(getItem));
          })
          .then((cachedItems) => {
            let news = document.getElementById("news");
            news.innerText = "";
            cachedItems.forEach((cachedItem) => renderNewsItem(news, cachedItem));
          });
      }

      function renderNewsItem(news, cachedItem) {
        let li = document.createElement("li");
        li.innerText = cachedItem.title;
        if (cachedItem.id === parseInt(sessionStorage.getItem(HIGHLIGHT))) li.classList.add(HIGHLIGHT);
        news.appendChild(li);
        li.addEventListener("click", (event) => {
          news.childNodes.forEach((item) => item.classList.remove(HIGHLIGHT));
          li.classList.add(HIGHLIGHT);
          sessionStorage.setItem(HIGHLIGHT, cachedItem.id);
          renderLinks(cachedItem);
          let comments = document.getElementById("comments");
          comments.innerHTML = "";
          requestItem(cachedItem.id).then((item) => {
            renderLinks(item);
            li.innerText = item.title;
            if (item.hasOwnProperty("kids")) {
              for (let i = 0; i < Math.min(item.kids.length, COMMENT_TREE_WIDTH); i++) {
                let d = document.createElement("details");
                comments.appendChild(d);
                renderComment(d, item.kids[i], 0, i, item.by);
              }
            } else {
              comments.appendChild(document.createTextNode("No comments yet."));
            }
            cacheItem(item);
          });
        });
      }

      function renderLinks(item) {
        let links = document.getElementById("links");
        links.innerHTML = `<a href="${item.url || HACKER_NEWS_ITEM + item.id}">${item.title}</a>${
          item.descendants && item.descendants > 0
            ? ` (<a href="${HACKER_NEWS_ITEM + item.id}">${item.descendants} comments</a>)`
            : ""
        }`;
      }

      function renderComment(currentComment, id, depth, index, by) {
        let commentText = document.createElement("summary");
        currentComment.prepend(commentText);
        if (depth >= COMMENT_TREE_DEPTH || index >= COMMENT_TREE_WIDTH) {
          commentText.innerText = ELLIPSIS;
          return;
        }
        if (depth === 0) currentComment.classList.add("hidden");
        requestItem(id).then((item) => {
          commentText.innerHTML = item.deleted
            ? "[deleted]"
            : `${item.text} [<a class="${by === item.by ? "op" : ""}" href="${HACKER_NEWS_ITEM + id}">${item.by}</a>]`;
          currentComment.classList.remove("hidden");
          if (item.hasOwnProperty("kids")) {
            for (let i = 0; i < Math.min(item.kids.length, COMMENT_TREE_WIDTH + 1); i++) {
              let d = document.createElement("details");
              currentComment.appendChild(d);
              renderComment(d, item.kids[i], depth + 1, i, item.by);
            }
          }
        });
      }
      /* currentComment.addEventListener("toggle", reload);
          function reload(event) {
            if (currentComment.open && currentComment.firstChild.innerText === ELLIPSIS) {
              currentComment.removeChild(currentComment.firstChild);
              renderComment(currentComment, id, 0, index - COMMENT_TREE_WIDTH, by);
              currentComment.removeEventListener("toggle", reload);
            }
          } */

      async function getItem(id) {
        let cached = sessionStorage.getItem(id);
        if (cached !== null) {
          return JSON.parse(cached);
        } else {
          let requested = await requestItem(id);
          cacheItem(requested);
          return requested;
        }
      }

      function requestItem(id) {
        return fetch(`${HACKER_NEWS_API}/item/${id}.json`).then(status).then(json);
      }

      function cacheItem(item) {
        if (item && item.id) {
          sessionStorage.setItem(item.id, JSON.stringify(item));
        }
      }

      function status(response) {
        if (response.status >= 200 && response.status < 300) {
          return Promise.resolve(response);
        } else {
          return Promise.reject(new Error(response.statusText));
        }
      }

      function json(response) {
        return response.json();
      }
    </script>
  </body>
</html>
